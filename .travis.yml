dist: bionic

language: ruby

rvm:
  - 2.4.1
  - 2.3.0
  - 2.2.3

env:
  global:
    - DB=postgresql
    - RAILS_ENV=test
    - CI_NODE_TOTAL=1
    - PGHOST=localhost
    - CI_NODE_INDEX=0
  matrix:
    - PGPORT=5432
    - PGPORT=5433

before_install:
  - gem install bundler -v 1.14.6

addons:
  apt:
    sources:
    - bionic-pgdg-9.6
    packages:
    - libcurl3
    - libcurl3-gnutls
    - libcurl4-openssl-dev
   #- postgresql-9.6
   #- postgresql-contrib-9.6
  postgresql: 9.6

bundler_args: --jobs=1 --retry=3

before_install:
  - "curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install.sh | sudo bash"
  - sudo apt-get update
 #- sudo apt-get --yes remove postgresql\*
  - sudo apt-get install -y postgresql-11 postgresql-client-11
  - sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
  - sudo perl -pi -e 's/^\s*port\s*=\s*\d+(.*)/port = 5433$1/' /etc/postgresql/11/main/postgresql.conf
  - sudo service postgresql restart 11
  - sudo cat /var/log/postgresql/postgresql-11-main.log
  - sudo cat /var/log/postgresql/postgresql-9.6-main.log
  - sudo psql -c 'CREATE ROLE travis SUPERUSER LOGIN CREATEDB;' -U postgres

script:
  - bundle exec rake pm:test:prepare
  - bundle exec rspec
