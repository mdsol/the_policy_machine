language: ruby

rvm:
  - 2.4.1
  - 2.3.0
  - 2.2.3
  - 2.5.0

services:
  - postgresql
  
env:
  global:
    - DB=postgresql
    - RAILS_ENV=test
    - CI_NODE_TOTAL=1
    - PGHOST=localhost
    - PGPORT=5432
  matrix:
    - CI_NODE_INDEX=0

before_install:
  - gem install bundler -v 1.14.6

addons:
  apt:
    packages:
    - libcurl3
    - libcurl3-gnutls
    - libcurl4-openssl-dev

bundler_args: --jobs=1 --retry=3

before_install:
  - sudo apt-get update
  - sudo apt-get --yes remove postgresql\*
  - sudo apt-get install -y postgresql-11 postgresql-client-11
  - sudo cp /etc/postgresql/{9.6,11}/main/pg_hba.conf
  - sudo service postgresql restart 11
  - sudo psql -c 'CREATE ROLE travis SUPERUSER LOGIN CREATEDB;' -U postgres

script:
  - bundle exec rake pm:test:prepare
  - bundle exec rspec
